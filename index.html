<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XO Game - Advanced Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        @keyframes xDraw {
            0% { clip-path: inset(0 0 100% 0); }
            50% { clip-path: inset(0 0 0 0); }
            100% { clip-path: inset(0 0 0 0); }
        }
        @keyframes oDraw {
            0% { clip-path: inset(100% 0 0 0); }
            50% { clip-path: inset(0 0 0 0); }
            100% { clip-path: inset(0 0 0 0); }
        }
        @keyframes winPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
            40%, 43% { transform: translate3d(0,-10px,0); }
            70% { transform: translate3d(0,-5px,0); }
            90% { transform: translate3d(0,-2px,0); }
        }
        .x-symbol { color: #ef4444; font-size: 4.5rem; font-weight: bold; animation: xDraw 0.6s ease-in-out; }
        .o-symbol { color: white; font-size: 4.5rem; font-weight: bold; animation: oDraw 0.6s ease-in-out; }
        .board { max-width: 550px; height: 550px; }
        .cell { height: calc(33.33% - 5px); border: 4px solid #333; transition: background 0.3s; }
        .cell:hover { background: rgba(255,255,255,0.1); }
        .winner-line { background: linear-gradient(90deg, #ffd700, #ff6b6b); animation: winPulse 1s infinite; }
        .player-active { animation: bounce 1s infinite; }
        .timer-warning { color: #ef4444; font-weight: bold; animation: bounce 0.5s infinite; }
        .first-move-btn { width: 250px; height: 90px; font-size: 1.8rem; }
        .start-restart-btn { width: 280px; height: 70px; font-size: 1.4rem; margin: 25px 0; }
        .name-input { width: 200px; height: 50px; font-size: 1.2rem; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen flex flex-col items-center justify-center p-4 text-white">
    <audio id="tapSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBqS0/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBqS0/" type="audio/wav">
    </audio>

    <!-- Player Names Input -->
    <div id="name-input-section" class="w-full max-w-4xl mb-12 text-center">
        <h3 class="text-3xl mb-8 font-bold">Enter Player Names</h3>
        <div class="flex justify-center space-x-8 mb-8">
            <div>
                <label class="block text-xl mb-2">Player 1 (X):</label>
                <input type="text" id="player1-name-input" class="name-input bg-gray-700 rounded-lg px-4 text-center font-bold" placeholder="Enter name" maxlength="10">
            </div>
            <div>
                <label class="block text-xl mb-2">Player 2 (O):</label>
                <input type="text" id="player2-name-input" class="name-input bg-gray-700 rounded-lg px-4 text-center font-bold" placeholder="Enter name" maxlength="10">
            </div>
        </div>
        <button id="confirm-names" class="px-12 py-4 bg-green-500 hover:bg-green-600 rounded-xl text-xl font-bold shadow-xl">Confirm Names & Continue</button>
    </div>

    <!-- Player Names and Timers -->
    <div id="player-info-section" class="w-full max-w-4xl flex justify-between mb-8 hidden">
        <div id="player1-info" class="text-left">
            <h2 id="player1-name" class="text-3xl font-bold">Player 1 (X)</h2>
            <div id="player1-timer" class="text-2xl mt-2 font-mono">00:10</div>
        </div>
        <div id="player2-info" class="text-right">
            <h2 id="player2-name" class="text-3xl font-bold">Player 2 (O)</h2>
            <div id="player2-timer" class="text-2xl mt-2 font-mono">00:10</div>
        </div>
    </div>

    <!-- First Move Selection -->
    <div id="first-move-selection" class="mb-12 text-center hidden">
        <h3 class="text-3xl mb-8 font-bold">Choose First Move</h3>
        <button id="player1-first" class="first-move-btn bg-red-500 hover:bg-red-600 mr-6 rounded-xl shadow-2xl font-bold">Player 1 First</button>
        <button id="player2-first" class="first-move-btn bg-blue-500 hover:bg-blue-600 rounded-xl shadow-2xl font-bold">Player 2 First</button>
    </div>

    <!-- Game Board -->
    <div id="game-board" class="board grid grid-cols-3 gap-2 mb-12 bg-gray-800 p-10 rounded-3xl shadow-3xl hidden">
        <div class="cell flex items-center justify-center cursor-pointer bg-gray-700 rounded-xl hover:shadow-lg" data-index="0"></div>
        <div class="cell flex items-center justify-center cursor-pointer bg-gray-700 rounded-xl hover:shadow-lg" data-index="1"></div>
        <div class="cell flex items-center justify-center cursor-pointer bg-gray-700 rounded-xl hover:shadow-lg" data-index="2"></div>
        <div class="cell flex items-center justify-center cursor-pointer bg-gray-700 rounded-xl hover:shadow-lg" data-index="3"></div>
        <div class="cell flex items-center justify-center cursor-pointer bg-gray-700 rounded-xl hover:shadow-lg" data-index="4"></div>
        <div class="cell flex items-center justify-center cursor-pointer bg-gray-700 rounded-xl hover:shadow-lg" data-index="5"></div>
        <div class="cell flex items-center justify-center cursor-pointer bg-gray-700 rounded-xl hover:shadow-lg" data-index="6"></div>
        <div class="cell flex items-center justify-center cursor-pointer bg-gray-700 rounded-xl hover:shadow-lg" data-index="7"></div>
        <div class="cell flex items-center justify-center cursor-pointer bg-gray-700 rounded-xl hover:shadow-lg" data-index="8"></div>
    </div>

    <!-- Controls -->
    <div id="controls" class="space-y-6 text-center hidden">
        <button id="start-game" class="start-restart-btn bg-green-500 hover:bg-green-600 rounded-2xl shadow-2xl font-bold block mx-auto">Start Game</button>
        <button id="restart-game" class="start-restart-btn bg-red-500 hover:bg-red-600 rounded-2xl shadow-2xl font-bold block mx-auto">Restart Game</button>
    </div>

    <!-- Status -->
    <div id="status" class="text-4xl font-bold mt-12 text-center">Welcome to XO Game!</div>

    <script>
        class XOGame {
            constructor() {
                this.board = Array(9).fill(null);
                this.currentPlayer = null;
                this.firstPlayer = null;
                this.gameActive = false;
                this.moveHistory = [];
                this.moveNumber = 0;
                this.currentTimer = null;
                this.player1Name = 'Player 1';
                this.player2Name = 'Player 2';
                this.xPositions = [];
                this.oPositions = [];
                this.init();
            }

            init() {
                this.cells = document.querySelectorAll('.cell');
                this.tapSound = document.getElementById('tapSound');
                this.statusEl = document.getElementById('status');
                this.gameBoard = document.getElementById('game-board');
                this.controls = document.getElementById('controls');
                this.firstMoveSelection = document.getElementById('first-move-selection');
                this.playerInfoSection = document.getElementById('player-info-section');
                this.nameInputSection = document.getElementById('name-input-section');
                
                // Name input events
                document.getElementById('confirm-names').addEventListener('click', () => this.confirmNames());
                document.getElementById('player1-name-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.confirmNames();
                });
                document.getElementById('player2-name-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.confirmNames();
                });

                // First move selection
                document.getElementById('player1-first').addEventListener('click', () => this.selectFirstPlayer(1));
                document.getElementById('player2-first').addEventListener('click', () => this.selectFirstPlayer(2));
                document.getElementById('start-game').addEventListener('click', () => this.startGame());
                document.getElementById('restart-game').addEventListener('click', () => this.restart());

                this.cells.forEach(cell => cell.addEventListener('click', (e) => this.handleCellClick(e)));
            }

            confirmNames() {
                this.player1Name = document.getElementById('player1-name-input').value || 'Player 1';
                this.player2Name = document.getElementById('player2-name-input').value || 'Player 2';
                
                document.getElementById('player1-name').textContent = this.player1Name + ' (X)';
                document.getElementById('player2-name').textContent = this.player2Name + ' (O)';
                
                this.nameInputSection.classList.add('hidden');
                this.playerInfoSection.classList.remove('hidden');
                this.statusEl.textContent = `Names set! Choose who starts first.`;
            }

            playSound() {
                const audio = this.tapSound.cloneNode();
                audio.play().catch(() => {});
            }

            selectFirstPlayer(playerNum) {
                this.firstPlayer = playerNum;
                this.currentPlayer = playerNum;
                document.getElementById('player1-first').classList.remove('bg-red-500');
                document.getElementById('player2-first').classList.remove('bg-blue-500');
                if (playerNum === 1) {
                    document.getElementById('player1-first').classList.add('bg-green-500');
                } else {
                    document.getElementById('player2-first').classList.add('bg-green-500');
                }
                this.firstMoveSelection.classList.add('hidden');
                this.controls.classList.remove('hidden');
                const playerName = playerNum === 1 ? this.player1Name : this.player2Name;
                this.updateStatus(`${playerName} starts first! Press Start Game`);
            }

            startGame() {
                this.gameActive = true;
                this.board = Array(9).fill(null);
                this.moveHistory = [];
                this.xPositions = [];
                this.oPositions = [];
                this.moveNumber = 0;
                this.gameBoard.classList.remove('hidden');
                this.updateBoard();
                this.nextTurn();
            }

            handleCellClick(e) {
                if (!this.gameActive || !this.currentPlayer) return;
                const index = parseInt(e.target.dataset.index);
                if (this.board[index]) return;

                const symbol = this.currentPlayer === 1 ? 'X' : 'O';
                this.board[index] = symbol;
                
                // Track positions and remove first one after 4th placement
                if (symbol === 'X') {
                    this.xPositions.push(index);
                    if (this.xPositions.length > 3) {
                        const removeIndex = this.xPositions.shift(); // Remove FIRST position
                        this.board[removeIndex] = null;
                    }
                } else {
                    this.oPositions.push(index);
                    if (this.oPositions.length > 3) {
                        const removeIndex = this.oPositions.shift(); // Remove FIRST position
                        this.board[removeIndex] = null;
                    }
                }
                
                this.moveHistory.push(index);
                this.moveNumber++;
                this.playSound();
                this.updateBoard();
                
                const winner = this.checkWinner();
                if (winner) {
                    this.endGame(winner);
                } else if (!this.board.includes(null)) {
                    this.endGame('Draw');
                } else {
                    this.switchPlayer();
                }
            }

            updateBoard() {
                this.cells.forEach((cell, index) => {
                    cell.innerHTML = '';
                    if (this.board[index]) {
                        const symbol = document.createElement('div');
                        symbol.className = this.board[index] === 'X' ? 'x-symbol' : 'o-symbol';
                        symbol.textContent = this.board[index];
                        cell.appendChild(symbol);
                    }
                });
            }

            switchPlayer() {
                this.currentPlayer = 3 - this.currentPlayer;
                this.nextTurn();
            }

            nextTurn() {
                this.startTimer();
                document.getElementById('player1-info').classList.toggle('player-active', this.currentPlayer === 1);
                document.getElementById('player2-info').classList.toggle('player-active', this.currentPlayer === 2);
            }

            startTimer() {
                clearInterval(this.currentTimer);
                const timeLimit = 10000; // 10 seconds for every move
                let timeLeft = timeLimit / 1000;
                const playerTimer = document.getElementById(`player${this.currentPlayer}-timer`);
                
                this.currentTimer = setInterval(() => {
                    timeLeft -= 0.1;
                    const secs = Math.floor(timeLeft);
                    playerTimer.textContent = `00:${secs.toString().padStart(2, '0')}`;
                    
                    if (timeLeft <= 3) {
                        playerTimer.classList.add('timer-warning');
                    }
                    
                    if (timeLeft <= 0) {
                        clearInterval(this.currentTimer);
                        const opponent = 3 - this.currentPlayer;
                        const opponentName = opponent === 1 ? this.player1Name : this.player2Name;
                        this.endGame(opponentName + ' wins by timeout!');
                    }
                }, 100);
            }

            checkWinner() {
                const winConditions = [
                    [0,1,2], [3,4,5], [6,7,8],
                    [0,3,6], [1,4,7], [2,5,8],
                    [0,4,8], [2,4,6]
                ];
                for (let condition of winConditions) {
                    const [a, b, c] = condition;
                    if (this.board[a] && this.board[a] === this.board[b] && this.board[a] === this.board[c]) {
                        condition.forEach(i => this.cells[i].classList.add('winner-line'));
                        return this.board[a];
                    }
                }
                return null;
            }

            endGame(winner) {
                this.gameActive = false;
                clearInterval(this.currentTimer);
                if (winner === 'Draw') {
                    this.statusEl.textContent = 'Game Draw!';
                } else if (typeof winner === 'string' && winner.includes('timeout')) {
                    this.statusEl.textContent = winner;
                    confetti({ particleCount: 100, spread: 70 });
                } else {
                    const playerNum = winner === 'X' ? 1 : 2;
                    const playerName = playerNum === 1 ? this.player1Name : this.player2Name;
                    this.statusEl.textContent = `${playerName} Wins! ðŸŽ‰`;
                    this.celebrateWin(playerNum);
                }
            }

            celebrateWin(playerNum) {
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 }
                });
                document.getElementById(`player${playerNum}-info`).style.transform = 'scale(1.3)';
                setTimeout(() => {
                    document.getElementById(`player${playerNum}-info`).style.transform = 'scale(1)';
                }, 3000);
            }

            restart() {
                this.gameActive = false;
                clearInterval(this.currentTimer);
                this.gameBoard.classList.add('hidden');
                this.controls.classList.add('hidden');
                this.firstMoveSelection.classList.remove('hidden');
                this.statusEl.textContent = 'Restarting... Enter names again!';
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('winner-line');
                });
                document.getElementById('player1-info').classList.remove('player-active');
                document.getElementById('player2-info').classList.remove('player-active');
                document.getElementById('player1-timer').textContent = '00:10';
                document.getElementById('player2-timer').textContent = '00:10';
                this.nameInputSection.classList.remove('hidden');
                this.playerInfoSection.classList.add('hidden');
            }

            updateStatus(message) {
                this.statusEl.textContent = message;
            }
        }

        const game = new XOGame();
    </script>
</body>
</html>
